# 1004_1005 TIL

## 잡다한 것

- 참고
  ![](1004_1005_assets/2023-10-07-15-51-42-image.png)

- pjt 관련 내용
  ![](1004_1005_assets/2023-10-07-15-52-01-image.png)

## Django Authentication System 1

### Cookie & Session

#### 개요

- **우리가 서버로부터 받은 페이지를 둘러볼 때 우리는 서버와 서로 연결되어 있는 상태가 아니다.**

- HTTP
  
  - HTML 문서와 같은 리소스들을 가져올 수 있도록 해주는 규약
  
  - 웹(WWW)에서 이루어지는 모든 데이터 교환의 기초

- HTTP 특징
  ![](1004_1005_assets/2023-10-07-09-37-58-image.png)

- 상태가 없다는 것은?
  ![](1004_1005_assets/2023-10-07-12-39-31-image.png)

#### 쿠키

- 쿠키(Cookie)란?
  
  - 서버가 사용자의 웹 브라우저에 전송하는 작은 데이터 조각

- 쿠키 사용 예시
  ![](1004_1005_assets/2023-10-07-12-40-47-image.png)

- 쿠키 사용 원리
  ![](1004_1005_assets/2023-10-07-12-41-02-image.png)

- 쿠키 사용 예(장바구니)
  
  - 만약에 쿠팡에서 호박고구마를 담았다면, 쿠팡 서버로 부터 쿠키를 받는다.
  
  - 해당 쿠키에는 장바구니에 호박고구마가 담겨있다라는 정보가 담겨있다.
  
  - 그리고 그 쿠키를 매 요청마다 계속 보낸다.

- 쿠키 사용 목적
  ![](1004_1005_assets/2023-10-07-12-41-30-image.png)

- 세션(Session)이란?
  
  - 쿠키 중에서도 상태를 유지하기 위한 목적을 가진 쿠키를 세션이라고 한다.
  
  - 상태 관리는 서버가 하는 것이다.
  
  - 서버 측에서 생성되어 클라이언트와 서버 간의 **상태를 유지**
  
  - 상태 정보를 저장하는 데이터 저장 방식
    
    - 쿠키에 세션 데이터를 저장하여 매 요청시마다 세션 데이터를 함께 보냄

- 세션 작동 원리
  ![](1004_1005_assets/2023-10-07-12-43-02-image.png)

- 세션 (정리)
  
  - 서버 측에서는 세션 데이터를 생성 후 저장하고 세션 ID를 생성
  
  - 이 ID를 클라이언트 측으로 전달하여, 클라이언트는 쿠키에 이 ID를 저장
  
  - 서버로 부터 쿠키를 받아 브라우저에 저장하고, 클라이언트가 같은 서버에 재요청 시마다 저장해 두었던 쿠키도 요청과 함께 전송
    
    - 예를 들어 로그인 상태 유지를 위해 로그인 되어있다는 사실을 입증하는 데이터를 매 요청마다 계속해서 보내는 것

- 쿠키와 세션의 목적
  
  - 서버와 클라이언트 간의 **상태를 유지**

#### 참고

![](1004_1005_assets/2023-10-07-12-46-13-image.png)
![](1004_1005_assets/2023-10-07-12-46-22-image.png)

#### Authentication System

- Django Authentication System(인증 시스템)
  
  - 사용자 인증과 관련된 기능을 모아 놓은 시스템

- Authentication(인증)
  
  - 사용자가 자신이 누구인지 확인하는 것(신원 확인)

- 사전 준비
  ![](1004_1005_assets/2023-10-07-12-48-49-image.png)

- 사전준비에 대한 참고 내용
  
  - 기존에 사용하던 articles앱에 기능을 추가해도 되지만, app을 나누는 기준이 기능단위이므로  accounts라는 앱을 이용할 것이다.
  
  - articles: 게시판에 대한 기능, accounts: 회원에 대한 기능 

### Custom User model

- Custom User model로 '**대체**'하기
  
  - django가 기존적으로 제공하는 User model은 내장된 auth 앱의 User 클래스를 사용

- 내장된 auth 앱
  ![](1004_1005_assets/2023-10-07-12-50-07-image.png)

- User 클래스를 대체하는 이유
  ![](1004_1005_assets/2023-10-07-12-50-25-image.png)

- 대체하기
  ![](1004_1005_assets/2023-10-07-12-50-48-image.png)
  ![](1004_1005_assets/2023-10-07-12-50-56-image.png)
  ![](1004_1005_assets/2023-10-07-12-51-06-image.png)
  
  - 위에 대한 내용(공식문서를 통해 보는 법)
    
    <img src="1004_1005_assets/2023-10-07-15-48-04-image.png" title="" alt="" width="393">
    <img src="1004_1005_assets/2023-10-07-15-48-14-image.png" title="" alt="" width="380">

![](1004_1005_assets/2023-10-07-12-51-28-image.png)

- 사용 User 테이블의 변화
  ![](1004_1005_assets/2023-10-07-12-51-52-image.png)

- **프로젝트를 시작하며 반드시 User 모델을 대체해야 한다.**
  
  ![](1004_1005_assets/2023-10-07-13-25-11-image.png)

### Login

- Login
  
  - Session을 Create하는 과정

<img src="1004_1005_assets/2023-10-07-13-27-03-image.png" title="" alt="" width="383">

이전에는 form을 직접 만들어서 이용했는데, 이번 인증 시스템에서 사용할 form들은 built-in-form으로 만들어져 있어서 가져다 쓸 것이다.

로그인에 사용되는 데이터는 인증만 있으면 되므로 DB 저장이 필요없으므로 ModelForm이 아닌 Form 형태이다.(단, 회원가입은 ModelForm임)

- 로그인 페이지 작성
  ![](1004_1005_assets/2023-10-07-13-27-31-image.png)
  
  ![](1004_1005_assets/2023-10-07-13-27-45-image.png)

- 로그인 로직 작성
  ![](1004_1005_assets/2023-10-07-13-28-04-image.png)

<img src="1004_1005_assets/2023-10-07-13-28-18-image.png" title="" alt="" width="332">
<img src="1004_1005_assets/2023-10-07-13-28-31-image.png" title="" alt="" width="368">

- 세션 데이터 확인하기
  ![](1004_1005_assets/2023-10-07-13-28-50-image.png)
  ![](1004_1005_assets/2023-10-07-13-29-00-image.png)

- 로그인 링크 작성
  ![](1004_1005_assets/2023-10-07-13-29-18-image.png)

### Logout

- Logout
  
  - Session을 Delete하는 과정

<img src="1004_1005_assets/2023-10-07-13-41-22-image.png" title="" alt="" width="320">

- 로그아웃 로직 작성
  ![](1004_1005_assets/2023-10-07-13-41-45-image.png)
  ![](1004_1005_assets/2023-10-07-13-42-03-image.png)

### Template with Authentication data

- Template with Authentication data
  
  - 템플릿에서 인증 관련 데이터를 출력하는 방법

- 현재 로그인 되어있는 유저 정보 출력하기
  ![](1004_1005_assets/2023-10-07-13-44-10-image.png)

- context processors
  ![](1004_1005_assets/2023-10-07-13-44-29-image.png)

#### 참고

![](1004_1005_assets/2023-10-07-13-44-47-image.png)
![](1004_1005_assets/2023-10-07-13-44-56-image.png)
![](1004_1005_assets/2023-10-07-13-45-04-image.png)
![](1004_1005_assets/2023-10-07-13-45-13-image.png)
![](1004_1005_assets/2023-10-07-13-45-24-image.png)

---

## Django Authentication System 2

### 회원 가입

- 회원 가입
  
  - User 객체를 Create하는 과정

<img src="1004_1005_assets/2023-10-07-13-47-08-image.png" title="" alt="" width="372">

- 회원 가입 페이지 작성(틀린 방식)
  ![](1004_1005_assets/2023-10-07-13-47-41-image.png)
  ![](1004_1005_assets/2023-10-07-13-47-53-image.png)

- 회원 가입 로직 작성(틀린 방식)
  ![](1004_1005_assets/2023-10-07-13-48-13-image.png)

- 회원 가입 로직 에러
  
  - modelform이다 보니 어떠한 모델에 연결이 되어있음을 의미하고 클래스 meta쪽에 과거에 썻던 과거의 유저클래스가 등록이 되어있어서 오류 발생
  
  - 해결법: 기존의 상속 받던 부분에서 meta 속의 model등록 된 것만 바꾸면 되므로 기존의 상속받던 form를 다시 상속 받고 해당하는 부분만 바꾸면 됨
    ![](1004_1005_assets/2023-10-07-13-48-29-image.png)
    ![](1004_1005_assets/2023-10-07-13-48-42-image.png)
  
  - 해진
    ![](1004_1005_assets/2023-10-07-15-57-03-image.png)

![](1004_1005_assets/2023-10-07-13-49-00-image.png)

- 회원 가입 로직 작성(회원 가입 로직 작성)
  ![](1004_1005_assets/2023-10-07-13-49-22-image.png)
  ![](1004_1005_assets/2023-10-07-15-57-34-image.png)

<img src="1004_1005_assets/2023-10-07-13-50-09-image.png" title="" alt="" width="371">

- User 모델을 직접 참조하지 않는 이유
  ![](1004_1005_assets/2023-10-07-13-50-31-image.png)
  
  - 자동으로 반환해줘서 유지보수에 Good
    
    - 이렇게 안하면 중간에 클래스 이름 등 변경사항이 발생 시 관련된 모든 코드를 찾아가 일일히 수정 필요

- 회원 가입 로직 작성(커스텀 form 적용)
  ![](1004_1005_assets/2023-10-07-13-51-08-image.png)

### 회원 탈퇴

- 회원 탈퇴
  
  - User 객체를 Delete 하는 과정

- 회원 탈퇴 로직 작성
  ![](1004_1005_assets/2023-10-07-13-52-17-image.png)
  
  ![](1004_1005_assets/2023-10-07-15-58-35-image.png)![](1004_1005_assets/2023-10-07-13-52-28-image.png)

### 회원정보 수정

- 회원정보 수정
  
  - User 객체를 Update 하는 과정

<img src="1004_1005_assets/2023-10-07-13-53-12-image.png" title="" alt="" width="280">

- 회원정보 수정 페이지 작성
  ![](1004_1005_assets/2023-10-07-13-53-38-image.png)
  ![](1004_1005_assets/2023-10-07-13-53-51-image.png)
  
  ![](1004_1005_assets/2023-10-07-13-54-29-image.png)

- UserChangeForm 사용 시 문제점
  ![](1004_1005_assets/2023-10-07-13-54-57-image.png)
  
  - 구글링 방법
    
    <img src="1004_1005_assets/2023-10-07-15-59-17-image.png" title="" alt="" width="431">

- CustomUserChangeForm 출력 필드 재정의
  ![](1004_1005_assets/2023-10-07-13-55-22-image.png)
  ![](1004_1005_assets/2023-10-07-13-55-30-image.png)

- 회원정보 수정 로직 작성
  ![](1004_1005_assets/2023-10-07-13-55-50-image.png)

### 비밀번호 변경

- 비밀번호 변경
  
  - 인증된 사용자의 Session 데이터를 Update 하는 과정

<img src="1004_1005_assets/2023-10-07-13-56-24-image.png" title="" alt="" width="336">

왜 ModelForm이 아닌 Form??
사용자의 기존의 Session 데이터를 갱신, 즉, 사용자가 입력한 데이터를 그대로 저장하는 과정이 아닌 사용자가 입력한 데이터를 암호화 거쳐서 그 결과물 하나만 db에 들어가 인증수단으로 이용함으로써 사용자의 입력 데이터가 직접적으로 db에 들어가지 않으므로

- 비밀번호 변경 페이지 작성
  ![](1004_1005_assets/2023-10-07-13-56-47-image.png)
  ![](1004_1005_assets/2023-10-07-13-57-00-image.png)
  ![](1004_1005_assets/2023-10-07-13-57-10-image.png)

- 비밀번호 변경 로직 작성
  ![](1004_1005_assets/2023-10-07-13-57-53-image.png)
  ![](1004_1005_assets/2023-10-07-16-08-24-image.png)

#### 세션 무효화 방지하기

- 암호 변경 시 세션 무효화
  ![](1004_1005_assets/2023-10-07-13-58-26-image.png)
  
  - 비밀번호 변경은 Session 데이터가 갱신되는 과정임
  
  - Session 데이터는 장고의 db에 있고 이 세션 데이터를 활용하는 키는 브라우저가 쿠키로 가지고 있어서 해당 키와 기존에 있던 Session 데이터가 일치해야 되는데 비밀번호가 변경됨으로써 사용자의 인증정보가 변경이 생겨 Session 데이터로 새로 만들게 됨
  
  - 그러면서 브라우저 입장에서 기존에 가지고 있던 Session키가 안 먹히게 되어서 로그아웃 됨

<img src="1004_1005_assets/2023-10-07-13-58-37-image.png" title="" alt="" width="429">

- update_session_auth_hash 적용
  ![](1004_1005_assets/2023-10-07-13-59-08-image.png)

### 인증된 사용자에 대한 접근 제한

- 로그인 사용자에 대해 접근을 제한하는 2가지 방법
  ![](1004_1005_assets/2023-10-07-14-22-42-image.png)

<img src="1004_1005_assets/2023-10-07-14-22-58-image.png" title="" alt="" width="414">

- is_authenticated 적용하기
  ![](1004_1005_assets/2023-10-07-14-23-33-image.png)
  ![](1004_1005_assets/2023-10-07-14-23-44-image.png)

<img src="1004_1005_assets/2023-10-07-14-24-06-image.png" title="" alt="" width="418">

- login_required 적용하기
  ![](1004_1005_assets/2023-10-07-14-24-34-image.png)
  ![](1004_1005_assets/2023-10-07-14-24-47-image.png)

#### 참고

![](1004_1005_assets/2023-10-07-14-25-03-image.png)
![](1004_1005_assets/2023-10-07-14-25-13-image.png)
![](1004_1005_assets/2023-10-07-14-25-23-image.png)
![](1004_1005_assets/2023-10-07-14-25-33-image.png)
![](1004_1005_assets/2023-10-07-14-25-43-image.png)
